# PR40 Invoice OCR pipeline review feedback

## Summary
Reviewing PR #40 locally uncovered blocking issues:

1. **Pydantic constraints break imports**
   - The branch updates `backend/src/models/ai_processing.py` to use `Field(max_digits=…, decimal_places=…)` on multiple `Decimal` fields. Our current Pydantic version (2.8.x) does not accept `max_digits` metadata, so importing `models.ai_processing` raises `ValueError: Unknown constraint max_digits/decimal_places` during test collection. Every unit/integration test fails before running.

2. **OCR state transitions still spam illegal-state warnings**
   - `_maybe_advance_invoice_from_file` transitions invoices to `OCR_DONE` only when `processing_status` is `UPLOADED` or `OCR_PENDING`. After the first page the invoice is already `OCR_PENDING`, so the second page still logs `invoice_processing_status` assertion warnings. The code also immediately schedules `process_invoice_document` before verifying AI extraction can actually run.

3. **New tests need to run on the current stack**
   - `backend/tests/unit/test_invoice_tasks.py` should monkeypatch the new helpers but must import without triggering the Pydantic crash. The same applies to `backend/tests/integration/test_invoice_upload_status.py`.

## How to Fix

1. **Update `models/ai_processing.py` for Pydantic 2.x**
   - Replace direct `Field(max_digits=…)` usage with `condecimal` or `Annotated` from `pydantic` 2.x. Example:
     ```python
     from pydantic import condecimal

     Decimal18_2 = condecimal(max_digits=18, decimal_places=2)

     class UnifiedFileBase(BaseModel):
         gross_amount_original: Optional[Decimal18_2] = None
     ```
     or use `typing.Annotated[Decimal, Field(...)]` with `json_schema_extra` for documentation only.
   - Ensure all decimal fields adopt the same pattern.

2. **Tighten invoice OCR orchestration**
   - Allow `_maybe_advance_invoice_from_file` to accept `OCR_PENDING` and `OCR_DONE` when transitioning so second/third pages do not produce “illegal state” metrics.
   - Defer scheduling `process_invoice_document` until `_invoice_page_progress` confirms all pages finished and ensure extraction is ready (otherwise the placeholder runs before any lines exist).

3. **Adjust tests to match the revised helpers**
   - Once the Pydantic fix lands, update `backend/tests/unit/test_invoice_tasks.py` and `backend/tests/integration/test_invoice_upload_status.py` to patch the new helper functions (e.g., `_maybe_advance_invoice_from_file`, `_set_invoice_metadata_field`) without hitting import errors.

## Verification
- Unit: `pytest backend/tests/unit/test_invoice_tasks.py`
- Integration: `pytest backend/tests/integration/test_invoice_upload_status.py`
- Confirm no `TransitionIllegal` metrics are emitted when running multi-page invoice OCR locally.

